name: Build and deploy docker image

on:
  push:
    branches:
      - main

env:
    location: "westeurope"
    resourceGroup: 'azpoe-hecmonitor-test'
    storage: 'azpoehecmonitortest'
    functionApp: 'rahulfunctionappgithubaction'
    skuStorage: 'Standard_LRS'
    functionsVersion: '4'
    pythonVersion: '3.11'
    AZURE_FUNCTIONAPP_PACKAGE_PATH: '.'
jobs:
  build-to-deploy:
    runs-on: ubuntu-latest
    defaults:
        run:
            shell: bash
    steps:

      - name: 'Checkout Repo'
        uses: actions/checkout@v4
      
      - name: Az login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          enable-AzPSSession: true

      - name: Listing Accounts
        run: |
          az account show

      - name: List function app
        run: |
          az functionapp list --resource-group 'azpoe-hecmonitor-test' --output json > functionapps.json
          cat functionapps.json

      - name: Install jq parser
        run: |
          sudo apt-get update
          sudo apt-get install jq

      - name: List result jq parser
        run: |
          cat functionapps.json | jq -r '.[] | select(.name | contains("rahul")) | {name: .name, state: .state}'
  
  deploy:
    runs-on: ubuntu-latest
    defaults:
        run:
            shell: bash
    steps:
        - name: Checkout Repo
          uses: actions/checkout@v4

        - name: Setup Python ${{ env.pythonVersion }} Environment
          uses: actions/setup-python@v4
          with:
            python-version: ${{ env.pythonVersion }}
    
        - name: 'Resolve Project Dependencies Using Pip'
          shell: bash
          run: |
            pwd
            pushd ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
            python -m pip install --upgrade pip
            pip install -r requirements.txt --target=".python_packages/lib/site-packages"
            popd
    
        - name: 'Run Azure Functions Action'
          uses: Azure/functions-action@v1
          id: fa
          with:
            app-name: ${{ env.functionApp }}
            package: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
            publish-profile: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}
            scm-do-build-during-deployment: true
            enable-oryx-build: true
    

